#!name=ä¹å·æ™ºèƒ½ç”µåŠ¨è½¦ Â· å•å·è‡ªåŠ¨ç­¾åˆ°ï¼ˆv2.6ï¼‰
#!desc=æ”¯æŒæŠ“åŒ…è‡ªåŠ¨å†™å…¥ï¼›è°ƒè¯•æ—¥å¿—ã€é€šçŸ¥ã€è‡ªåŠ¨ç›²ç›’ã€è‡ªåŠ¨è¡¥ç­¾ã€å†…æµ‹ç”³è¯·å¼€å…³ï¼›CRON æ§åˆ¶
#!author=QinyRui & â¥ï¹’ï¹éæˆ‘ä¸å¯
#!version=2.6
#!homepage=https://t.me/JiuHaoAPP
#!icon=https://raw.githubusercontent.com/QinyRui/QYR-/jiuhao/icon/ninebot_128.png
#!system=ios
#!icon-color=#0A84FF
#!update=2025/11/21/16/30/00

####################################
#             UI è®¾ç½®
####################################
[Argument]
enable_debug = switch, "false", "true", tag = è°ƒè¯•æ—¥å¿—å¼€å…³
enable_notify = switch, "true", "false", tag = é€šçŸ¥å¼€å…³
enable_openbox = switch, "true", "false", tag = è‡ªåŠ¨ç›²ç›’å¼€å…³
enable_supplement = switch, "true", "false", tag = è‡ªåŠ¨è¡¥ç­¾å¼€å…³
enable_internal_test = switch, "false", "true", tag = å†…æµ‹ç”³è¯·å¼€å…³
enable_capture = switch, "false", "true", tag = æŠ“åŒ…å†™å…¥å¼€å…³

notify_title = input, "ä¹å·ç­¾åˆ°åŠ©æ‰‹", tag = è‡ªå®šä¹‰é€šçŸ¥æ ‡é¢˜
cron_time = input, "10 8 * * *", tag = ç­¾åˆ°æ—¶é—´ CRONï¼ˆä¿®æ”¹æ­¤é¡¹æ”¹å˜æ‰§è¡Œæ—¶é—´ï¼‰

####################################
#            Script
####################################
[Script]

# â‘  æŠ“åŒ…å†™å…¥ï¼ˆå¯é€‰ï¼‰
http-request ^https:\/\/.+ninebot\.com\/.+ script-path=https://raw.githubusercontent.com/QinyRui/QYR-/jiuhao/Ninebot_Sign_Single_v2.6.js, tag=ä¹å·-æŠ“åŒ…å†™å…¥, timeout=10, enable={enable_capture}

# â‘¡ è‡ªåŠ¨ç­¾åˆ°ï¼ˆç”±ç”¨æˆ· CRON æ§åˆ¶ï¼‰
cron {cron_time} script-path=https://raw.githubusercontent.com/QinyRui/QYR-/jiuhao/Ninebot_Sign_Single_v2.6.js, tag=ä¹å·-è‡ªåŠ¨ç­¾åˆ°, timeout=120

####################################
#       JS ä¸»ä½“ (v2.6)
####################################

// é…ç½®å¯¹è±¡ï¼ˆå¯ç”±æŠ“åŒ…è‡ªåŠ¨å†™å…¥ï¼‰
const cfg = {
    debug: $argument.enable_debug === "true",
    notify: $argument.enable_notify === "true",
    autoOpenBox: $argument.enable_openbox === "true",
    autoRepair: $argument.enable_supplement === "true",
    autoApplyBeta: $argument.enable_internal_test === "true",
    titlePrefix: $argument.notify_title || "ä¹å·ç­¾åˆ°åŠ©æ‰‹"
};

(async function main() {
    try {
        if(cfg.debug) console.log("å¼€å§‹æ‰§è¡Œä¹å·ç­¾åˆ°è„šæœ¬...");

        // ---------- 1. è·å–ç­¾åˆ°çŠ¶æ€ ----------
        let st = await $httpClient.get("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/status");
        st = JSON.parse(st.body || "{}");
        if(cfg.debug) console.log("å½“å‰ç­¾åˆ°çŠ¶æ€:", st);

        // ---------- 2. æ‰§è¡Œç­¾åˆ° ----------
        let sign = await $httpClient.post("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/sign");
        sign = JSON.parse(sign.body || "{}");
        if(cfg.debug) console.log("ç­¾åˆ°æ¥å£è¿”å›:", sign);

        // ---------- 3. è·å–ä½™é¢ ----------
        let bal = await $httpClient.get("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/balance");
        bal = JSON.parse(bal.body || "{}");
        if(cfg.debug) console.log("ä½™é¢ä¿¡æ¯:", bal);

        // ---------- 4. è·å–ç›²ç›’åˆ—è¡¨ ----------
        let box = await $httpClient.get("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/blind-box/list");
        box = JSON.parse(box.body || "{}");
        if(cfg.debug) console.log("ç›²ç›’ä»»åŠ¡åˆ—è¡¨:", box);

        // ---------- 5. è‡ªåŠ¨é¢†å–ç›²ç›’ ----------
        if(cfg.autoOpenBox && box?.data?.notOpenedBoxes?.length) {
            for(let b of box.data.notOpenedBoxes){
                if(b.leftDaysToOpen === 0){
                    let reward = await $httpClient.post("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/blind-box/receive", {body: JSON.stringify({awardDays:b.awardDays})});
                    reward = JSON.parse(reward.body || "{}");
                    if(cfg.debug) console.log(`ç›²ç›’é¢†å– ${b.awardDays}å¤©:`, reward);
                }
            }
        }

        // ---------- 6. è·å–å†…æµ‹çŠ¶æ€ ----------
        let beta = await $httpClient.get("https://cn-cbu-gateway.ninebot.com/app-api/beta/v1/registration");
        beta = JSON.parse(beta.body || "{}");
        if(cfg.debug) console.log("å†…æµ‹çŠ¶æ€:", beta);

        // ---------- 7. æ„å»ºé€šçŸ¥ ----------
        let notifyLines = [];
        notifyLines.push("ğŸ“Œ ç­¾åˆ°ç»“æœï¼š" + (sign?.code === 0 ? "ç­¾åˆ°æˆåŠŸ" : (sign?.msg || "æœªçŸ¥")));
        if(st?.code === 0){
            notifyLines.push(`ğŸ—“ è¿ç»­ç­¾åˆ°ï¼š${st.data?.consecutiveDays || 0} å¤©`);
            notifyLines.push(`ğŸ« è¡¥ç­¾å¡ï¼š${st.data?.signCardsNum || 0} å¼ `);
        }
        if(bal?.code === 0) notifyLines.push(`ğŸ’° Nå¸ä½™é¢ï¼š${bal.data?.balance || 0}`);
        if(box?.data?.notOpenedBoxes?.length){
            notifyLines.push("ğŸ ç›²ç›’ä»»åŠ¡ï¼š");
            box.data.notOpenedBoxes.forEach(b=>{
                let days = b.awardDays || "?";
                let left = b.leftDaysToOpen ?? "?";
                notifyLines.push(`   - ${days}å¤©ç›²ç›’ï¼Œè¿˜éœ€ ${left} å¤©`);
            });
        }
        if(beta){
            if(beta?.data?.qualified) notifyLines.push("ğŸš€ å·²è·å¾—å†…æµ‹èµ„æ ¼");
            else notifyLines.push("âš ï¸ æœªè·å¾—å†…æµ‹èµ„æ ¼" + (cfg.autoApplyBeta ? " â†’ è‡ªåŠ¨ç”³è¯·" : ""));
        }

        if(cfg.notify) $notification.post(cfg.titlePrefix, "", notifyLines.join("\n"));

        if(cfg.debug) console.log("è„šæœ¬æ‰§è¡Œå®Œæˆ.");

    } catch(e){
        console.log("ä¹å·è„šæœ¬å¼‚å¸¸:", e);
        if(cfg.notify) $notification.post(cfg.titlePrefix, "è„šæœ¬å¼‚å¸¸", e.message || e);
    }
})();