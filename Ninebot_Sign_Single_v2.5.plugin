#!name=ä¹å·æ™ºèƒ½ç”µåŠ¨è½¦ Â· å•è´¦å·è‡ªåŠ¨ç­¾åˆ°
#!desc=è°ƒè¯•æ—¥å¿—/é€šçŸ¥/è‡ªåŠ¨ç›²ç›’/è¡¥ç­¾/å†…æµ‹å¼€å…³ï¼›å¯ä¿®æ”¹ç­¾åˆ°æ—¶é—´ï¼›æ”¯æŒæŠ“åŒ…è‡ªåŠ¨å†™å…¥ Authorization/DeviceId/User-Agent
#!author=â¥ï¹’ï¹éæˆ‘ä¸å¯
#!version=2.5
#!homepage=https://t.me/JiuHaoAPP
#!icon=https://raw.githubusercontent.com/QinyRui/QYR-/jiuhao/icon/ninebot_128.png
#!system=ios
#!icon-color=#0A84FF

[General]
# æ’ä»¶å®‰è£…åè‡ªåŠ¨åˆ›å»ºç­¾åˆ°å®šæ—¶ä»»åŠ¡
cron "ä¹å·ç­¾åˆ°" script-path=Ninebot_Sign_Single_v2.5.plugin cronexpr=@daily timeout=120

[Script]
# ======== è‡ªåŠ¨æŠ“åŒ…å†™å…¥ ========
http-request ^https:\/\/.+ninebot\.com\/.+ script-path=Ninebot_Sign_Single_v2.5.plugin requires-body=false tag=ä¹å·-è‡ªåŠ¨å†™å…¥

# ======== ä¸»ä½“ç­¾åˆ°è„šæœ¬ ========
script-path=Ninebot_Sign_Single_v2.5.plugin timeout=120 tag=ä¹å·-æ‰§è¡Œç­¾åˆ°

[Argument]
# å¼€å…³æ§åˆ¶
enable_debug = switch,true,false,tag=è°ƒè¯•æ—¥å¿—å¼€å…³
enable_notify = switch,true,true,tag=é€šçŸ¥å¼€å…³
enable_openbox = switch,true,true,tag=è‡ªåŠ¨å¼€å¯ç›²ç›’å¼€å…³
enable_supplement = switch,true,true,tag=è‡ªåŠ¨è¡¥ç­¾å¼€å…³
enable_internal_test = switch,true,false,tag=å†…æµ‹ç”³è¯·å¼€å…³

# æ–‡æœ¬æ¡†
notify_title = text,default=ä¹å·ç­¾åˆ°åŠ©æ‰‹,tag=é€šçŸ¥æ ‡é¢˜
cron_time = text,default=0 8 * * *,tag=ç­¾åˆ°æ—¶é—´ CRON
authorization = text,default=,tag=Authorization
device_id = text,default=,tag=DeviceId
user_agent = text,default=,tag=User-Agent

# ======== è„šæœ¬é€»è¾‘ ========
script= """
// ---------- é…ç½® ----------
const DEBUG = $.read('enable_debug') === 'true';
const NOTIFY = $.read('enable_notify') === 'true';
const AUTO_BOX = $.read('enable_openbox') === 'true';
const AUTO_REPAIR = $.read('enable_supplement') === 'true';
const INTERNAL_TEST = $.read('enable_internal_test') === 'true';
const TITLE = $.read('notify_title') || 'ä¹å·ç­¾åˆ°åŠ©æ‰‹';
const AUTH = $.read('authorization') || '';
const DEVICE = $.read('device_id') || '';
const UA = $.read('user_agent') || 'Mozilla/5.0 (iPhone; CPU iPhone OS 18_7) Mobile';

function log(...args){ if(DEBUG) console.log('[Ninebot]', ...args); }
function notify(title, sub, body){ if(NOTIFY && typeof $notification !== 'undefined') $notification.post(title, sub, body); }

// ---------- HTTP Helper ----------
function httpPost({url, headers, body}) {
    return new Promise((resolve, reject)=>{
        $httpClient.post({url, headers, body}, (err, resp, data)=>{
            if(err) reject(err);
            else{
                try{ resolve(JSON.parse(data)); } catch{ resolve({raw: data}); }
            }
        });
    });
}
function httpGet({url, headers}){
    return new Promise((resolve, reject)=>{
        $httpClient.get({url, headers}, (err, resp, data)=>{
            if(err) reject(err);
            else{
                try{ resolve(JSON.parse(data)); } catch{ resolve({raw:data}); }
            }
        });
    });
}

// ---------- Endpoints ----------
const HEADERS = {
    "Authorization": AUTH,
    "device_id": DEVICE,
    "User-Agent": UA,
    "Content-Type":"application/json",
    "platform":"h5",
    "Origin":"https://h5-bj.ninebot.com",
    "language":"zh"
};
const END = {
    sign: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/sign",
    status: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/status",
    balance: "https://cn-cbu-gateway.ninebot.com/portal/self-service/task/account/money/balance?appVersion=609103606",
    blindBoxList: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/blind-box/list",
    blindBoxReceive: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/blind-box/receive",
    repair: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/repair",
    internalTest: "https://cn-cbu-gateway.ninebot.com/app-api/beta/v1/registration"
};

// ---------- ä¸»æµç¨‹ ----------
(async ()=>{
    let notifyBody = '';
    try{
        // 1) ç­¾åˆ°
        log('å¼€å§‹ç­¾åˆ°...');
        const sign = await httpPost({url: END.sign, headers: HEADERS, body: JSON.stringify({deviceId:DEVICE})});
        log('ç­¾åˆ°è¿”å›ï¼š', sign);
        if(sign?.code===0) notifyBody += `ğŸ‰ ç­¾åˆ°æˆåŠŸï¼Œ+${sign.data?.nCoin||0} Nå¸`;
        else if(sign?.code===540004) notifyBody += `âš ï¸ ä»Šæ—¥å·²ç­¾åˆ°`;
        else notifyBody += `âŒ ç­¾åˆ°å¤±è´¥ï¼š${sign?.msg||'æœªçŸ¥'}`;

        // 2) æŸ¥è¯¢çŠ¶æ€
        const st = await httpGet({url: END.status, headers: HEADERS});
        log('çŠ¶æ€è¿”å›ï¼š', st);
        if(st?.code===0){
            const data = st.data||{};
            notifyBody += `\nğŸ—“ è¿ç»­ç­¾åˆ°ï¼š${data.consecutiveDays||0} å¤©`;
            notifyBody += `\nğŸ« è¡¥ç­¾å¡ï¼š${data.signCardsNum||0} å¼ `;
        }

        // 3) æŸ¥è¯¢ä½™é¢
        const bal = await httpGet({url: END.balance, headers: HEADERS});
        log('ä½™é¢è¿”å›ï¼š', bal);
        if(bal?.code===0) notifyBody += `\nğŸ’° Nå¸ä½™é¢ï¼š${bal.data?.balance||0}`;

        // 4) ç›²ç›’
        const box = await httpGet({url: END.blindBoxList, headers: HEADERS});
        log('ç›²ç›’è¿”å›ï¼š', box);
        const notOpened = box?.data?.notOpenedBoxes||[];
        if(notOpened.length>0){
            notifyBody += `\n\nğŸ“¦ ç›²ç›’ä»»åŠ¡ï¼š`;
            for(const b of notOpened){
                const days = b.boxDays||b.awardDays||'?';
                const left = b.leftDaysToOpen||b.diffDays||'?';
                notifyBody += `\n- ${days}å¤©ç›²ç›’ï¼Œè¿˜éœ€ ${left} å¤©`;
            }
            if(AUTO_BOX){
                for(const b of notOpened.filter(b=>b.leftDaysToOpen===0||b.diffDays===0)){
                    const r = await httpPost({url: END.blindBoxReceive, headers: HEADERS, body:"{}"});
                    notifyBody += `\nğŸ ${b.boxDays||b.awardDays}å¤©ç›²ç›’é¢†å–${r?.code===0?'æˆåŠŸ':'å¤±è´¥'}`;
                }
            }
        }

        // 5) è‡ªåŠ¨è¡¥ç­¾
        if(AUTO_REPAIR && st?.code===0){
            const cards = st.data?.signCardsNum||0;
            const days = st.data?.consecutiveDays||0;
            if(cards>0 && days===0){
                const rep = await httpPost({url: END.repair, headers: HEADERS, body:"{}"});
                notifyBody += `\nğŸ”§ è‡ªåŠ¨è¡¥ç­¾${rep?.code===0?'æˆåŠŸ':'å¤±è´¥'}`;
            }
        }

        // 6) å†…æµ‹ç”³è¯·
        if(INTERNAL_TEST){
            const test = await httpPost({url: END.internalTest, headers: HEADERS, body:"{}"});
            notifyBody += `\nğŸ“ å†…æµ‹çŠ¶æ€ï¼š${test?.data?.status||'æœªç”³è¯·'}`;
        }

        // æœ€ç»ˆé€šçŸ¥
        notify(TITLE,'ç­¾åˆ°ç»“æœ',notifyBody);

    }catch(e){
        log('å¼‚å¸¸ï¼š', e);
        notify(TITLE,'è„šæœ¬å¼‚å¸¸',String(e));
    }
})();
"""