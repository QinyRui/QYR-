/*
è„šæœ¬ä½œè€…ï¼šQinyRui
æ›´æ–°æ—¶é—´ï¼š2024-10-13 17:59:33
åŠŸèƒ½ï¼š
  - è‡ªåŠ¨ç­¾åˆ°
  - è‡ªåŠ¨è¡¥ç­¾
  - è‡ªåŠ¨å¼€å¯ç›²ç›’
  - æ‰‹åŠ¨æ‰§è¡Œç­¾åˆ°
*/

const $ = new ToolClient();

// ---------- é…ç½®è¯»å–ä¸å†™å…¥ ----------
// BoxJS é…ç½®
const KEY_AUTH = "ninebot.authorization";
const KEY_DEV = "ninebot.deviceId";
const KEY_UA = "ninebot.userAgent";
const KEY_DEBUG = "ninebot.debug";
const KEY_NOTIFY = "ninebot.notify";
const KEY_AUTOBOX = "ninebot.autoOpenBox";
const KEY_AUTOREPAIR = "ninebot.autoRepair";
const KEY_AUTOAPPLYBETA = "ninebot.autoApplyBeta";
const KEY_NOTIFYFAIL = "ninebot.notifyFail";
const KEY_TITLE = "ninebot.titlePrefix";

// é…ç½®æ–‡ä»¶è·¯å¾„
const read = (k) => (typeof $persistentStore !== "undefined" ? $persistentStore.read(k) : null);
const write = (v, k) => { if (typeof $persistentStore !== "undefined") return $persistentStore.write(v, k); };

// è¯»å–é…ç½®
const cfg = {
  Authorization: read(KEY_AUTH) || "",
  DeviceId: read(KEY_DEV) || "",
  userAgent: read(KEY_UA) || "",
  debug: read(KEY_DEBUG) === "false" ? false : true,
  notify: read(KEY_NOTIFY) === "false" ? false : true,
  autoOpenBox: read(KEY_AUTOBOX) === "true",
  autoRepair: read(KEY_AUTOREPAIR) === "true",
  autoApplyBeta: read(KEY_AUTOAPPLYBETA) === "true",
  notifyFail: read(KEY_NOTIFYFAIL) === "false" ? false : true,
  titlePrefix: read(KEY_TITLE) || "ä¹å·ç­¾åˆ°"
};

// ---------- æŠ“åŒ…å†™å…¥ ----------
// è‡ªåŠ¨æŠ“åŒ…å†™å…¥é…ç½®
const captureRequest = () => {
  const parse = (delimiter) => (str) =>
    Object.fromEntries(str.split(delimiter).map((v) => v.split("=")));

  const { wps_sids } = parse(/;\s+?/g)($request.headers?.cookie ?? "");

  if (wps_sids) {
    write(wps_sids, "WPS_info");
    $.msg("WPSæ¯æ—¥ç­¾åˆ°", "æˆåŠŸæ•è·å¹¶ä¿å­˜Cookie");
  } else {
    $.msg("WPSæ¯æ—¥ç­¾åˆ°", "æœªæˆåŠŸæ•è·Cookie");
  }
};

// ---------- HTTP è¯·æ±‚å·¥å…· ----------
function httpPost({ url, headers, body = "{}" }) {
  return new Promise((resolve, reject) => {
    $httpClient.post({ url, headers, body }, (err, resp, data) => {
      if (err) reject(err);
      else {
        try { resolve(JSON.parse(data || "{}")); } catch (e) { resolve({ raw: data }); }
      }
    });
  });
}

function httpGet({ url, headers }) {
  return new Promise((resolve, reject) => {
    $httpClient.get({ url, headers }, (err, resp, data) => {
      if (err) reject(err);
      else {
        try { resolve(JSON.parse(data || "{}")); } catch (e) { resolve({ raw: data }); }
      }
    });
  });
}

// ---------- ä¸»é€»è¾‘ ----------

// æ‰§è¡Œç­¾åˆ°çš„ä¸»å‡½æ•°
!(async () => {
  let notifyBody = "";

  try {
    // 1) æ£€æŸ¥é…ç½®æ˜¯å¦å®Œå¤‡
    if (!cfg.Authorization || !cfg.DeviceId) {
      $.notify(cfg.titlePrefix, "æœªé…ç½® Token", "è¯·å…ˆå¼€å¯æŠ“åŒ…å¹¶åœ¨ä¹å· App é‡Œæ“ä½œä»¥å†™å…¥ Authorization ä¸ DeviceId");
      $done();
      return;
    }

    // 2) ç­¾åˆ°è¯·æ±‚
    const sign = await httpPost({
      url: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/sign",
      headers: {
        "Authorization": cfg.Authorization,
        "Content-Type": "application/json",
        "device_id": cfg.DeviceId,
        "User-Agent": cfg.userAgent || "Mozilla/5.0 (iPhone; CPU iPhone OS 18_7) Mobile/15E148 Segway v6",
        "platform": "h5",
        "Origin": "https://h5-bj.ninebot.com",
        "language": "zh"
      },
      body: JSON.stringify({ deviceId: cfg.DeviceId })
    });

    if (sign && sign.code === 0) {
      notifyBody += `ğŸ‰ ç­¾åˆ°æˆåŠŸ\nğŸ +${sign.data?.nCoin || sign.data?.score || 0} Nå¸`;
    } else if (sign && sign.code === 540004) {
      notifyBody += `âš ï¸ ä»Šæ—¥å·²ç­¾åˆ°`;
    } else {
      notifyBody += `âŒ ç­¾åˆ°å¤±è´¥ï¼š${sign && (sign.msg || safeStr(sign)) || "æœªçŸ¥"}`;
      if (!cfg.notifyFail) notifyBody = "";
    }

    // 3) çŠ¶æ€æ£€æŸ¥
    const st = await httpGet({ url: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/status", headers });
    if (st && st.code === 0) {
      const data = st.data || {};
      const days = data.consecutiveDays || data.continuousDays || 0;
      const cards = data.signCardsNum || data.remedyCard || 0;
      notifyBody += `\nğŸ—“ è¿ç»­ç­¾åˆ°ï¼š${days} å¤©\nğŸ« è¡¥ç­¾å¡ï¼š${cards} å¼ `;
    }

    // 4) ä½™é¢ä¿¡æ¯
    const bal = await httpGet({ url: "https://cn-cbu-gateway.ninebot.com/portal/self-service/task/account/money/balance?appVersion=609103606", headers });
    if (bal && bal.code === 0) notifyBody += `\nğŸ’° Nå¸ä½™é¢ï¼š${bal.data?.balance || 0}`;

    // 5) è‡ªåŠ¨å¼€å¯ç›²ç›’
    if (cfg.autoOpenBox) {
      const box = await httpGet({ url: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/blind-box/list", headers });
      if (box && box.data?.notOpenedBoxes?.length > 0) {
        notifyBody += `\nğŸ“¦ ç›²ç›’ä»»åŠ¡ï¼š`;
        for (const b of box.data.notOpenedBoxes) {
          const left = b.leftDaysToOpen || b.diffDays || "?";
          notifyBody += `\n- ${b.awardDays || b.boxDays}å¤©ç›²ç›’ï¼Œè¿˜éœ€ ${left} å¤©`;
        }
      }
    }

    // 6) è‡ªåŠ¨è¡¥ç­¾
    if (cfg.autoRepair) {
      const repair = await httpPost({
        url: "https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/repair",
        headers,
        body: "{}"
      });
      if (repair && repair.code === 0) notifyBody += `\nğŸ”§ è‡ªåŠ¨è¡¥ç­¾æˆåŠŸ`;
      else notifyBody += `\nğŸ”§ è‡ªåŠ¨è¡¥ç­¾å¤±è´¥ï¼š${repair && repair.msg || "æœªçŸ¥"}`;
    }

    // 7) æœ€ç»ˆé€šçŸ¥
    if (cfg.notify) $.notify(cfg.titlePrefix, "ç­¾åˆ°ç»“æœ", notifyBody);
  } catch (e) {
    if (cfg.notify) $.notify(cfg.titlePrefix, "è„šæœ¬å¼‚å¸¸", String(e));
  }

  $done();
})();