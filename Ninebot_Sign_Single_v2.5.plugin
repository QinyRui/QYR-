#!name=ä¹å·æ™ºèƒ½ç”µåŠ¨è½¦ Â· å•è´¦å·ç­¾åˆ°åŠ©æ‰‹
#!desc=æ”¯æŒæŠ“åŒ…å†™å…¥ã€æ‰‹åŠ¨è¾“å…¥ã€ç­¾åˆ°/ç›²ç›’/è¡¥ç­¾/å†…æµ‹è‡ªåŠ¨å¤„ç†ã€å¸¦æ—¥å¿—ä¸Žé€šçŸ¥
#!author=â¥ï¹’ï¹éžæˆ‘ä¸å¯ & QinyRui
#!version=2.5
#!system=ios
#!icon=https://raw.githubusercontent.com/QinyRui/QYR-/jiuhao/icon/ninebot_128.png
#!icon-color=#0A84FF

[Argument]
Authorization = input, "", tag = Authorizationï¼ˆæŠ“åŒ…æˆ–æ‰‹åŠ¨å¡«å†™ï¼‰
DeviceId = input, "", tag = DeviceIdï¼ˆæŠ“åŒ…æˆ–æ‰‹åŠ¨å¡«å†™ï¼‰
UserAgent = input, "", tag = User-Agentï¼ˆæŠ“åŒ…æˆ–æ‰‹åŠ¨å¡«å†™ï¼‰

notify_title = input, "ä¹å·ç­¾åˆ°åŠ©æ‰‹", tag = è‡ªå®šä¹‰é€šçŸ¥æ ‡é¢˜
enable_debug = switch, "false", "true", tag = è°ƒè¯•æ—¥å¿—
enable_notify = switch, "true", "false", tag = æ‰§è¡Œå®Œæˆé€šçŸ¥
enable_openbox = switch, "true", "false", tag = è‡ªåŠ¨å¼€å¯ç›²ç›’
enable_supplement = switch, "false", "true", tag = è‡ªåŠ¨è¡¥ç­¾
enable_internal_test = switch, "false", "true", tag = è‡ªåŠ¨ç”³è¯·å†…æµ‹
cron_time = input, "10 8 * * *", tag = ç­¾åˆ°æ—¶é—´ï¼ˆCRONï¼‰

#########################################
# ===== æŠ“åŒ…å†™å…¥ + ç­¾åˆ°ï¼ˆå†…ç½®è„šæœ¬ï¼‰ =====
#########################################

[Script]

# æŠ“åŒ…å†™å…¥ï¼ˆç«‹å³è§¦å‘ï¼‰
http-request ^https:\/\/.+ninebot\.com\/.+ script-name=ä¹å·-å†™å…¥è´¦å·

# è‡ªåŠ¨ç­¾åˆ°ï¼ˆå®šæ—¶ï¼‰
cron {cron_time} script-name=ä¹å·-è‡ªåŠ¨ç­¾åˆ°, timeout=120


############################
#   ===== å†…ç½® JS =====
############################

[Script Script]
ä¹å·-å†™å…¥è´¦å· = type=http-request,script=\

const isReq = typeof $request !== "undefined";

function read(k){return $argument[k] || "";}
function write(v,k){$loon.setArgument(k,v);}

if(isReq){
  const h = $request.headers;
  const auth = h.Authorization || h.authorization || "";
  const dev = h.DeviceId || h.deviceid || h.device_id || "";
  const ua = h["User-Agent"] || h["user-agent"] || "";

  let changed = false;
  if(auth){ write(auth, "Authorization"); changed = true; }
  if(dev){ write(dev, "DeviceId"); changed = true; }
  if(ua){ write(ua, "UserAgent"); changed = true; }

  if(changed){
    $notification.post("ä¹å·ç­¾åˆ°åŠ©æ‰‹","æŠ“åŒ…æˆåŠŸ","Authorization / DeviceId / User-Agent å·²å†™å…¥");
  }

  $done({});
}

ä¹å·-è‡ªåŠ¨ç­¾åˆ° = type=cron,script=\

function read(k){return $argument[k] || "";}
function notify(t,s,b){ if(read("enable_notify")!=="false") $notification.post(t,s,b); }
function log(...a){ if(read("enable_debug")==="true") console.log("[Ninebot]",...a); }

const Authorization = read("Authorization");
const DeviceId = read("DeviceId");
const UserAgent = read("UserAgent");
const title = read("notify_title") || "ä¹å·ç­¾åˆ°åŠ©æ‰‹";

if(!Authorization || !DeviceId){
  notify(title,"æœªç»‘å®šè´¦å·","è¯·å…ˆæŠ“åŒ…å†™å…¥ Authorization ä¸Ž DeviceId");
  $done(); return;
}

const headers = {
  Authorization,
  "Content-Type":"application/json",
  device_id:DeviceId,
  "User-Agent":UserAgent || "Mozilla/5.0 (iPhone; CPU iPhone OS 18_7) Mobile/15E148 Segway v6",
  platform:"h5",
  Origin:"https://h5-bj.ninebot.com",
  language:"zh"
};

function post(url,body="{}"){
  return new Promise(res =>
    $httpClient.post({url,headers,body},(_,__,data)=>{
      try{res(JSON.parse(data||"{}"));}catch{res({raw:data})}
    })
  );
}
function get(url){
  return new Promise(res =>
    $httpClient.get({url,headers},(_,__,data)=>{
      try{res(JSON.parse(data||"{}"));}catch{res({raw:data})}
    })
  );
}

(async ()=>{
  let out="";

  // ç­¾åˆ°
  const sign = await post("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/sign", JSON.stringify({deviceId:DeviceId}));
  log("ç­¾åˆ°ï¼š",sign);

  if(sign.code===0) out += `ðŸŽ‰ ç­¾åˆ°æˆåŠŸ +${sign.data?.nCoin || 0} Nå¸\n`;
  else if(sign.code===540004) out += "âš ï¸ ä»Šæ—¥å·²ç­¾åˆ°\n";
  else out += `âŒ ç­¾åˆ°å¤±è´¥ï¼š${sign.msg}\n`;

  // çŠ¶æ€
  const st = await get("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/status");
  log("çŠ¶æ€ï¼š",st);
  const days = st?.data?.consecutiveDays || 0;
  const cards = st?.data?.signCardsNum || 0;
  out += `ðŸ—“ è¿žç»­ç­¾åˆ°ï¼š${days} å¤©\nðŸŽ« è¡¥ç­¾å¡ï¼š${cards} å¼ \n`;

  // ä½™é¢
  const bal = await get("https://cn-cbu-gateway.ninebot.com/portal/self-service/task/account/money/balance?appVersion=609103606");
  out += `ðŸ’° å½“å‰ Nå¸ï¼š${bal?.data?.balance || 0}\n`;

  // ç›²ç›’
  const box = await get("https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/blind-box/list");
  log("ç›²ç›’ï¼š",box);

  if(box?.data){
    const list = box.data.notOpenedBoxes || box.data || [];
    if(list.length>0){
      out += "\nðŸ“¦ ç›²ç›’ä»»åŠ¡ï¼š";
      list.forEach(x=>{
        out += `\n- ${x.awardDays||"?"}å¤©ç›²ç›’ï¼Œè¿˜éœ€ ${x.leftDaysToOpen||"?"}å¤©`;
      });
    }
  }

  notify(title,"ç­¾åˆ°ç»“æžœ",out);
  $done();
})();